<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Parquet File Viewer</title>

        <!-- DataTables CSS -->
        <link
            rel="stylesheet"
            href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
        />

        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

        <!-- DataTables JS -->
        <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

        <style>
            #progressContainer {
                display: none;
                margin: 20px 0;
            }
            #progressBar {
                width: 100%;
                height: 30px;
                background-color: #f0f0f0;
                border-radius: 5px;
                overflow: hidden;
            }
            #progressFill {
                height: 100%;
                background-color: #4caf50;
                width: 0%;
                transition: width 0.3s;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
            }
            #tableContainer {
                margin-top: 20px;
            }
            #queryInput {
                width: 100%;
                padding: 10px;
                margin: 10px 0;
                font-family: monospace;
                font-size: 14px;
            }
        </style>
    </head>
    <body>
        <h1>Parquet File Viewer</h1>

        <input type="file" id="fileInput" accept=".parquet" />

        <div>
            <input
                type="text"
                id="queryInput"
                value="SELECT * FROM 'file.parquet' LIMIT 10"
            />
        </div>

        <button id="loadButton">Run Query</button>

        <div id="progressContainer">
            <div id="progressBar">
                <div id="progressFill">0%</div>
            </div>
        </div>

        <div id="tableContainer"></div>

        <script type="module">
            import * as duckdb from "https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@latest/+esm";

            let db = null;
            let conn = null;

            // Initialize DuckDB
            async function initDuckDB() {
                const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
                const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);

                const worker_url = URL.createObjectURL(
                    new Blob([`importScripts("${bundle.mainWorker}");`], {
                        type: "text/javascript",
                    })
                );

                const worker = new Worker(worker_url);
                const logger = new duckdb.ConsoleLogger();
                db = new duckdb.AsyncDuckDB(logger, worker);
                await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
                URL.revokeObjectURL(worker_url);

                conn = await db.connect();
                console.log("DuckDB initialized successfully");
            }

            // Update progress bar
            function updateProgress(percent, message) {
                const progressContainer =
                    document.getElementById("progressContainer");
                const progressFill = document.getElementById("progressFill");

                progressContainer.style.display = "block";
                progressFill.style.width = percent + "%";
                progressFill.textContent = message || percent + "%";
            }

            // Hide progress bar
            function hideProgress() {
                document.getElementById("progressContainer").style.display =
                    "none";
            }

            // Render table using DataTables
            function renderTable(data) {
                if (data.length === 0) {
                    document.getElementById("tableContainer").innerHTML =
                        "<p>No data to display</p>";
                    return;
                }

                // Get column names from first row
                const columns = Object.keys(data[0]).map((key) => ({
                    title: key,
                    data: key,
                }));

                // Clear previous table if exists
                const tableContainer =
                    document.getElementById("tableContainer");
                tableContainer.innerHTML =
                    '<table id="dataTable" class="display" style="width:100%"></table>';

                // Initialize DataTable
                $("#dataTable").DataTable({
                    data: data,
                    columns: columns,
                    pageLength: 10,
                    destroy: true,
                });
            }

            // Load and query parquet file
            async function loadParquetFile(file, customQuery) {
                try {
                    updateProgress(0, "Starting...");
                    console.log(`Loading file: ${file.name}`);

                    updateProgress(25, "Reading file...");
                    // Read file as ArrayBuffer
                    const arrayBuffer = await file.arrayBuffer();
                    const uint8Array = new Uint8Array(arrayBuffer);

                    updateProgress(50, "Registering in DuckDB...");
                    // Register the file in DuckDB
                    await db.registerFileBuffer(file.name, uint8Array);

                    updateProgress(75, "Executing query...");
                    // Execute query - use custom query or default
                    const query =
                        customQuery || `SELECT * FROM '${file.name}' LIMIT 10`;
                    console.log(`Executing query: ${query}`);

                    const result = await conn.query(query);
                    const rows = result.toArray().map((row) => row.toJSON());

                    console.log("Query results:");
                    console.table(rows);
                    console.log("Raw data:", rows);

                    updateProgress(100, "Complete!");

                    // Render the table
                    setTimeout(() => {
                        hideProgress();
                        renderTable(rows);
                    }, 500);
                } catch (error) {
                    console.error("Error loading parquet file:", error);
                    hideProgress();
                    alert("Error loading parquet file: " + error.message);
                }
            }

            // Initialize on page load
            initDuckDB()
                .then(() => {
                    const fileInput = document.getElementById("fileInput");
                    const queryInput = document.getElementById("queryInput");

                    // Set default query when file is selected
                    fileInput.addEventListener("change", () => {
                        const file = fileInput.files[0];
                        if (file) {
                            queryInput.value = `SELECT * FROM '${file.name}' LIMIT 10`;
                        }
                    });

                    document
                        .getElementById("loadButton")
                        .addEventListener("click", async () => {
                            const file = fileInput.files[0];

                            if (!file) {
                                alert("Please select a parquet file first");
                                return;
                            }

                            const query = queryInput.value.trim();
                            if (!query) {
                                alert("Please enter a query");
                                return;
                            }

                            await loadParquetFile(file, query);
                        });
                })
                .catch((error) => {
                    console.error("Failed to initialize DuckDB:", error);
                });
        </script>
    </body>
</html>
