<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Parkett</title>

        <!-- DataTables CSS - UIKit styling -->
        <link
            rel="stylesheet"
            href="https://cdn.datatables.net/1.13.6/css/dataTables.uikit.min.css"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.16.22/css/uikit.min.css"
        />

        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

        <!-- DataTables JS -->
        <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.6/js/dataTables.uikit.min.js"></script>

        <style>
            * {
                box-sizing: border-box;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                    Roboto, "Helvetica Neue", Arial, sans-serif;
                margin: 0;
                padding: 0;
                background: white;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }

            h1 {
                margin: 0 0 20px 0;
                color: #333;
                font-size: 24px;
                font-weight: 600;
            }

            .form-group {
                margin-bottom: 15px;
            }

            label {
                display: block;
                margin-bottom: 5px;
                color: #555;
                font-weight: 500;
                font-size: 14px;
            }

            input[type="file"] {
                display: block;
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                font-size: 14px;
            }

            #queryInput {
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
                font-size: 14px;
            }

            #queryInput:focus {
                outline: none;
                border-color: #4a90e2;
            }

            .button-group {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
            }

            button {
                padding: 8px 16px;
                border: none;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                font-family: inherit;
            }

            #loadButton {
                background: #4a90e2;
                color: white;
                flex: 1;
            }

            #loadButton:hover {
                background: #357abd;
            }

            #exportButton {
                background: #f0f0f0;
                color: #333;
                border: 1px solid #ddd;
            }

            #exportButton:hover {
                background: #e0e0e0;
            }

            #progressContainer {
                display: none;
                margin: 15px 0;
            }

            #progressBar {
                width: 100%;
                height: 30px;
                background-color: #f0f0f0;
                overflow: hidden;
            }

            #progressFill {
                height: 100%;
                background: #4a90e2;
                width: 0%;
                transition: width 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 500;
                font-size: 14px;
            }

            #tableContainer {
                margin-top: 20px;
                overflow-x: auto;
            }

            #dataTable thead th {
                background: #4a90e2;
                color: white !important;
                font-weight: 600;
            }

            #dataTable tbody tr:hover {
                background-color: #f0f7ff;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="form-group">
                <label for="fileInput">Select Parquet File</label>
                <input type="file" id="fileInput" accept=".parquet" />
            </div>

            <div class="form-group">
                <label for="queryInput">SQL Query</label>
                <input
                    type="text"
                    id="queryInput"
                    value="SELECT * FROM 'file.parquet' LIMIT 10"
                />
            </div>

            <div class="button-group">
                <button id="loadButton">Run Query</button>
                <button id="exportButton">Export to CSV</button>
            </div>

            <div id="progressContainer">
                <div id="progressBar">
                    <div id="progressFill">0%</div>
                </div>
            </div>

            <div id="tableContainer"></div>
        </div>

        <script type="module">
            import * as duckdb from "https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@latest/+esm";

            let db = null;
            let conn = null;
            let lastQueryResults = null;

            // Initialize DuckDB
            async function initDuckDB() {
                const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
                const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);

                const worker_url = URL.createObjectURL(
                    new Blob([`importScripts("${bundle.mainWorker}");`], {
                        type: "text/javascript",
                    })
                );

                const worker = new Worker(worker_url);
                const logger = new duckdb.ConsoleLogger();
                db = new duckdb.AsyncDuckDB(logger, worker);
                await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
                URL.revokeObjectURL(worker_url);

                conn = await db.connect();
                console.log("DuckDB initialized successfully");
            }

            // Update progress bar
            function updateProgress(percent, message) {
                const progressContainer =
                    document.getElementById("progressContainer");
                const progressFill = document.getElementById("progressFill");

                progressContainer.style.display = "block";
                progressFill.style.width = percent + "%";
                progressFill.textContent = message || percent + "%";
            }

            // Hide progress bar
            function hideProgress() {
                document.getElementById("progressContainer").style.display =
                    "none";
            }

            // Export data to CSV
            function exportToCSV(data) {
                if (!data || data.length === 0) {
                    alert("No data to export");
                    return;
                }

                // Get column headers
                const headers = Object.keys(data[0]);

                // Create CSV content
                let csvContent = headers.join(",") + "\n";

                // Add data rows
                data.forEach((row) => {
                    const values = headers.map((header) => {
                        let value = row[header];
                        // Handle null/undefined
                        if (value === null || value === undefined) {
                            return "";
                        }
                        // Escape quotes and wrap in quotes if contains comma, quote, or newline
                        value = String(value);
                        if (
                            value.includes(",") ||
                            value.includes('"') ||
                            value.includes("\n")
                        ) {
                            value = '"' + value.replace(/"/g, '""') + '"';
                        }
                        return value;
                    });
                    csvContent += values.join(",") + "\n";
                });

                // Create blob and download
                const blob = new Blob([csvContent], {
                    type: "text/csv;charset=utf-8;",
                });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);

                link.setAttribute("href", url);
                link.setAttribute("download", "query_results.csv");
                link.style.visibility = "hidden";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            // Render table using DataTables
            function renderTable(data) {
                if (data.length === 0) {
                    document.getElementById("tableContainer").innerHTML =
                        "<p>No data to display</p>";
                    return;
                }

                // Get column names from first row
                const columns = Object.keys(data[0]).map((key) => ({
                    title: key,
                    data: key,
                }));

                // Clear previous table if exists
                const tableContainer =
                    document.getElementById("tableContainer");
                tableContainer.innerHTML =
                    '<div style="overflow-x: auto;"><table id="dataTable" class="display" style="width:100%"></table></div>';

                // Initialize DataTable
                $("#dataTable").DataTable({
                    data: data,
                    columns: columns,
                    pageLength: 10,
                    destroy: true,
                });
            }

            // Load and query parquet file
            async function loadParquetFile(file, customQuery) {
                try {
                    updateProgress(0, "Starting...");
                    console.log(`Loading file: ${file.name}`);

                    updateProgress(25, "Reading file...");
                    // Read file as ArrayBuffer
                    const arrayBuffer = await file.arrayBuffer();
                    const uint8Array = new Uint8Array(arrayBuffer);

                    updateProgress(50, "Registering in DuckDB...");
                    // Register the file in DuckDB
                    await db.registerFileBuffer(file.name, uint8Array);

                    updateProgress(75, "Executing query...");
                    // Execute query - use custom query or default
                    const query =
                        customQuery || `SELECT * FROM '${file.name}' LIMIT 10`;
                    console.log(`Executing query: ${query}`);

                    const result = await conn.query(query);
                    const rows = result.toArray().map((row) => row.toJSON());

                    // Store results for export
                    lastQueryResults = rows;

                    console.log("Query results:");
                    console.table(rows);
                    console.log("Raw data:", rows);

                    updateProgress(100, "Complete!");

                    // Render the table
                    setTimeout(() => {
                        hideProgress();
                        renderTable(rows);
                    }, 500);
                } catch (error) {
                    console.error("Error loading parquet file:", error);
                    hideProgress();
                    alert("Error loading parquet file: " + error.message);
                }
            }

            // Initialize on page load
            initDuckDB()
                .then(() => {
                    const fileInput = document.getElementById("fileInput");
                    const queryInput = document.getElementById("queryInput");

                    // Set default query when file is selected
                    fileInput.addEventListener("change", () => {
                        const file = fileInput.files[0];
                        if (file) {
                            queryInput.value = `SELECT * FROM '${file.name}' LIMIT 10`;
                        }
                    });

                    document
                        .getElementById("loadButton")
                        .addEventListener("click", async () => {
                            const file = fileInput.files[0];

                            if (!file) {
                                alert("Please select a parquet file first");
                                return;
                            }

                            const query = queryInput.value.trim();
                            if (!query) {
                                alert("Please enter a query");
                                return;
                            }

                            await loadParquetFile(file, query);
                        });

                    document
                        .getElementById("exportButton")
                        .addEventListener("click", () => {
                            if (!lastQueryResults) {
                                alert(
                                    "No query results to export. Please run a query first."
                                );
                                return;
                            }
                            exportToCSV(lastQueryResults);
                        });
                })
                .catch((error) => {
                    console.error("Failed to initialize DuckDB:", error);
                });
        </script>
    </body>
</html>
